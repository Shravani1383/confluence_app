import asyncio
from autogen_agentchat.agents import AssistantAgent
from autogen_ext.models.openai import AzureOpenAIChatCompletionClient
from autogen_ext.tools.mcp import StdioServerParams, mcp_server_tools
from autogen_core import CancellationToken
from autogen_agentchat.ui import Console

from config.env_setup import init_env_and_session, ensure_azure_openai_no_proxy
from common import gpt_4o_config
import os

# --------------------------------------------------
# Azure setup
# --------------------------------------------------

init_env_and_session()

api_key = os.environ.get("AZURE_OPENAI_API_KEY") or gpt_4o_config.get("api_key")
if not api_key:
    raise RuntimeError("Azure OpenAI API key not found")

try:
    ensure_azure_openai_no_proxy()
except Exception:
    pass

model_client = AzureOpenAIChatCompletionClient(
    azure_deployment=gpt_4o_config.get("deployment"),
    model=gpt_4o_config.get("model"),
    api_version=gpt_4o_config.get("api_version"),
    azure_endpoint=gpt_4o_config.get("api_base"),
    api_key=api_key,
    parallel_tool_calls=False,  # REQUIRED for chaining
)

# --------------------------------------------------
# MCP server params (LOCAL stdio server)
# --------------------------------------------------

confluence_server = StdioServerParams(
    command="python",
    args=["mcp_server.py"],  # path to your MCP server
)

# Load tools exposed by MCP server
confluence_tools = asyncio.run(mcp_server_tools(confluence_server))

# --------------------------------------------------
# Agent
# --------------------------------------------------

agent = AssistantAgent(
    name="confluence_agent",
    model_client=model_client,
    tools=confluence_tools,
    system_message="""
You are an enterprise Confluence assistant.

Rules:
- Always search Confluence first.
- Fetch relevant pages using their URLs.
- Answer strictly from fetched content.
- Never hallucinate.
""",
)

# --------------------------------------------------
# Run
# --------------------------------------------------

async def main():
    await Console(
        agent.run_stream(
            task="What features are included in the productivity suite?",
            cancellation_token=CancellationToken(),
        )
    )

if __name__ == "__main__":
    asyncio.run(main())
