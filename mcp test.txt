import asyncio
import os

from autogen_agentchat.agents import AssistantAgent
from autogen_ext.models.openai import AzureOpenAIChatCompletionClient
from autogen_ext.tools.mcp import MCPToolAdapter

from config.env_setup import init_env_and_session, ensure_azure_openai_no_proxy
from common import gpt_4o_config

# --------------------------------------------------
# Azure setup (matches your screenshot)
# --------------------------------------------------

init_env_and_session()

api_key = os.environ.get("AZURE_OPENAI_API_KEY") or gpt_4o_config.get("api_key")
if not api_key:
    raise RuntimeError("Azure OpenAI API key not found")

try:
    ensure_azure_openai_no_proxy()
except Exception:
    pass

model_client = AzureOpenAIChatCompletionClient(
    azure_deployment=gpt_4o_config.get("deployment"),
    model=gpt_4o_config.get("model"),
    api_version=gpt_4o_config.get("api_version"),
    azure_endpoint=gpt_4o_config.get("api_base"),
    api_key=api_key,
    parallel_tool_calls=False,  # IMPORTANT for chaining
)

# --------------------------------------------------
# MCP tools (search + fetch)
# --------------------------------------------------

confluence_tools = MCPToolAdapter(
    name="confluence",
    command="python",
    args=["mcp_server.py"],
)

# --------------------------------------------------
# Agent
# --------------------------------------------------

agent = AssistantAgent(
    name="confluence_agent",
    model_client=model_client,
    tools=[confluence_tools],
    system_message="""
You are an enterprise Confluence assistant.

To answer questions:
1. Search Confluence using keywords.
2. Review search results.
3. Fetch the most relevant pages using their URLs.
4. Answer strictly based on fetched content.
""",
)

# --------------------------------------------------
# Run
# --------------------------------------------------

async def main():
    result = await agent.run(
        task="What features are included in the productivity suite?"
    )

    print("\n=== ANSWER ===\n")
    print(result.messages[-1].content)

if __name__ == "__main__":
    asyncio.run(main())
