import asyncio

from confluence_agent.confluence_agents import (
    create_confluence_agent,
    create_cql_builder_agent,
)

from validation.response_guard import (
    validate_agent_response,
    validate_cql_response,
)


async def run_with_guard(agent, task: str, retries: int = 2):
    """
    Runs an agent with schema validation and retry-on-failure.
    """
    last_error = None

    for _ in range(retries + 1):
        result = await agent.run(task=task)
        final_message = result.messages[-1].content

        try:
            return validate_agent_response(final_message)
        except RuntimeError as e:
            last_error = str(e)
            task = f"""
Your previous response was INVALID.

Error:
{last_error}

Fix your response so it EXACTLY matches the schema.
"""

    raise RuntimeError(last_error)


async def main():
    user_query = (
        "Search Confluence for HSBC Productivity Suite features "
        "and give me a brief overview of its software development life cycle."
    )

    # --------------------------------------------------
    # 1️⃣ Create agents
    # --------------------------------------------------
    cql_agent = create_cql_builder_agent()
    confluence_agent = create_confluence_agent()

    # --------------------------------------------------
    # 2️⃣ Build CQL using CQL agent
    # --------------------------------------------------
    cql_result = await cql_agent.run(task=user_query)
    cql_message = cql_result.messages[-1].content

    cql_query = validate_cql_response(cql_message)

    print("\nGenerated CQL:")
    print(cql_query.cql)

    # --------------------------------------------------
    # 3️⃣ Pass CQL to execution agent
    # --------------------------------------------------
    execution_task = f"""
Use the following Confluence CQL query to answer the user.

CQL:
{cql_query.cql}

Limit:
{cql_query.limit}

Instructions:
- Search Confluence using this CQL
- Fetch relevant pages if needed
- Produce a structured answer
"""

    response = await run_with_guard(
        agent=confluence_agent,
        task=execution_task,
        retries=2,
    )

    # --------------------------------------------------
    # 4️⃣ Output final validated response
    # --------------------------------------------------
    print("\nFinal Response:")
    print(response.model_dump_json(indent=2))


if __name__ == "__main__":
    asyncio.run(main())
